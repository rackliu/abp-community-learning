# 第十部：部署、升級與遷移（章 22–23）

本檔為章 22–23 教材草稿，包含容器化、Kubernetes/Helm、CI/CD 自動化腳本，以及開源版升級與從 ASP.NET Boilerplate 遷移實務指引。

## 學習目標
- 熟悉 Docker 與 Helm 的部署流程
- 能設計 CI/CD pipeline（建置、測試、打包、部署）
- 理解 ABP 升級與資料庫遷移策略
- 掌握從 ASP.NET Boilerplate 遷移至 ABP Framework 的要點

## 先修需求
- 熟悉 Docker、Kubernetes 基礎
- .NET/ABP 專案建置與測試經驗

## 22 容器化與 Kubernetes 部署

### Docker 映像與最佳實務
建立簡單 Dockerfile（以 ASP.NET Core 為例）：
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS base
WORKDIR /app
EXPOSE 80

FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src
COPY . .
RUN dotnet restore
RUN dotnet publish -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=build /app/publish .
ENTRYPOINT ["dotnet", "YourApp.Web.dll"]
```

建置與推送：
```bash
# bash
docker build -t myregistry/myapp:1.0 .
docker push myregistry/myapp:1.0
```

最佳實務簡述：
- 使用多階段建置減少映像大小
- 將敏感設定透過環境變數或 Secret 管理
- 對映像打標籤並維護 SemVer 流程

### Docker Compose（開發/本地）
```yaml
version: '3.8'
services:
  myapp:
    image: myregistry/myapp:1.0
    ports:
      - "5000:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
```

### Kubernetes 與 Helm
使用 Helm 管理部署，可建立 Chart 並參數化 values。
範例部署指令：
```bash
# bash
helm upgrade --install myapp ./chart --namespace production --values ./values.prod.yaml
```

Helm 建議：
- 在 values 中管理映像標籤、資源限制、環境變數與 ingress 配置
- 使用 readiness/liveness probes 與探針
- 使用 Kubernetes Secret 或 External Secrets 管理敏感資料

## CI/CD 基礎自動化腳本

### GitHub Actions 範例
```yaml
name: CI/CD
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 9.0.x
      - name: Restore
        run: dotnet restore
      - name: Build
        run: dotnet build --configuration Release --no-restore
      - name: Test
        run: dotnet test --no-build --configuration Release
      - name: Publish
        run: dotnet publish src/YourApp.Web -c Release -o publish
      - name: Build Docker image
        run: docker build -t ${{ secrets.REGISTRY }}/myapp:${{ github.sha }} .
      - name: Push Docker image
        run: |
          echo ${{ secrets.REGISTRY_PASSWORD }} | docker login ${{ secrets.REGISTRY }} -u ${{ secrets.REGISTRY_USER }} --password-stdin
          docker push ${{ secrets.REGISTRY }}/myapp:${{ github.sha }}
      - name: Deploy with Helm
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
        run: helm upgrade --install myapp ./chart --namespace production --set image.tag=${{ github.sha }}
```

### CI/CD 建議
- 在 pipeline 中分段（build/test/publish/deploy）並在關鍵點產生 artifact
- 執行環境自動化（migration）需安全控管與回滾方案

## 23 升級策略與遷移指引

### 升級 ABP 社群版步驟（通用）
1. 先在分支建立升級測試分支  
2. 更新 NuGet 套件到目標版本（查看 release notes）  
3. 編譯並執行測試，修正 API/樣板破壞性變更  
4. 執行資料庫遷移測試（在測試 DB 上）  
5. 經驗證後合併並逐步在 staging/production 部署

常用命令：
```bash
# bash
dotnet tool install -g Volo.Abp.Studio.Cli
abp --version
dotnet add package Volo.Abp --version 9.3.*
dotnet ef migrations add UpgradeMigration
dotnet ef database update
```

### 從 ASP.NET Boilerplate (ABP v2.x / ASP.NET Boilerplate) 遷移要點
- 先評估現有專案使用的模組與自訂擴充點  
- 尋找相對應的 ABP Framework 模組或重新實作缺失功能  
- 建立新的 ABP Framework 專案，採漸進式遷移策略（模組化替換）  
- 資料遷移：視情況選擇直接 SQL 轉換、ETL 或雙寫策略以確保一致性  
- 詳細步驟（精簡）：
  1. 建立新專案骨架（abp new）並確認基礎模組  
  2. 將 Domain/Entity 移植並比對欄位、索引與映射  
  3. 撰寫資料遷移腳本或使用中介層同步資料  
  4. 在 staging 驗證功能與資料完整性

### 資料庫遷移與回滾
- 在升級前務必備份資料庫並驗證備份可用性  
- 在 migration 中加入版本檢查與安全檢查點  
- 提供回滾腳本（必要時）或保留舊系統讀取路徑以便迅速回復

## 實務檢查清單（部署/升級）
- [ ] 代碼已經通過自動化測試（單元/整合）  
- [ ] Docker 映像已標記並發佈至註冊表  
- [ ] Kubernetes Helm values 已設定並檢查 Secret/ConfigMap  
- [ ] 資料庫已備份並測試還原  
- [ ] 監控與警示已配置（health checks, logs, metrics）  
- [ ] 回滾計畫與聯絡人已確認

## 參考資源
- ABP 官方文件（Deployment、Migration）：https://docs.abp.io  
- Kubernetes / Helm / Docker 官方文件

檔案：[`content/part10-ch22-23.md`](content/part10-ch22-23.md:1)