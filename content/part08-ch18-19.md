# 第八部：效能優化與安全強化（章 18–19）

本檔為章 18–19 教材草稿，包含快取策略、查詢優化、Redis 範例、N+1 問題解法，以及安全授權與資料保護實作說明。

## 學習目標
- 理解分散式快取與 Redis 在 ABP 中的應用
- 掌握查詢性能優化與 N+1 問題解法
- 實作資料加密、DataProtection 與日誌/審計配置
- 把效能與安全納入 CI/CD 與監控流程

## 18 快取策略與效能優化

### 核心觀念
- 將快取放在合適的層級：記憶體快取（Memory Cache）→ 分散式快取（Redis）→ 邏輯/查詢快取
- 快取失效策略：絕對過期、滑動過期、主動失效
- 保持快取與資料一致性的策略：事件驅動或短 TTL

### Redis 快取整合（範例）
於 Module 的 ConfigureServices 中註冊 Redis：
```csharp
// csharp
public override void ConfigureServices(ServiceConfigurationContext context)
{
    // 註冊 StackExchange.Redis 作為分散式快取
    context.Services.AddStackExchangeRedisCache(options =>
    {
        options.Configuration = configuration["Redis:Configuration"];
        options.InstanceName = "MyApp:";
    });

    // ABP 分散式快取設定（示意）
    Configure<AbpDistributedCacheOptions>(options =>
    {
        options.KeyPrefix = "MyApp_";
    });
}
```

### 快取層次與策略說明
- 使用 MemoryCache 作為近端快取以減少網路呼叫
- 對於高頻讀取且少更新的資料（如字典表）使用長 TTL
- 對修改頻繁資料使用短 TTL 或不快取

### 查詢最佳化與 N+1 問題
避免 N+1: 使用 Include / ThenInclude、投影（Select）或專用查詢
```csharp
// csharp
var orders = await _dbContext.Orders
    .Include(o => o.Items)
    .Where(o => o.Status == OrderStatus.Confirmed)
    .ToListAsync();
```

實作建議：
- 使用 AsNoTracking() 於唯讀查詢
- 使用投影 (Select) 只取需要欄位
- 使用分頁與索引優化 (索引必須在 DB 上設定)

### Redis 使用範例：讀寫與失效
先安裝套件：
```bash
# bash
dotnet add package Microsoft.Extensions.Caching.StackExchangeRedis
```

程式碼：
```csharp
// csharp
public class BookCacheService
{
    private readonly IDistributedCache _cache;
    public BookCacheService(IDistributedCache cache) => _cache = cache;

    public async Task<BookDto> GetOrSetAsync(Guid id, Func<Task<BookDto>> factory)
    {
        var key = $"book:{id}";
        var bytes = await _cache.GetAsync(key);
        if (bytes != null) return Deserialize<BookDto>(bytes);
        var value = await factory();
        await _cache.SetAsync(key, Serialize(value), new DistributedCacheEntryOptions { AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(10) });
        return value;
    }
}
```

## 效能指標與監控
- 收集指標（響應時間、錯誤率、DB 查詢時間）
- 使用 Application Insights / Prometheus + Grafana
- 設定警示（高延遲、Cache miss 率過高）

## 19 安全授權與資料保護

### 權限與授權最佳實務
- 採用最小權限原則（least privilege）
- 在應用層使用 ABP 的 AuthorizeAttribute 與 Permission 檢查
- 為關鍵 API 使用策略化授權

### 資料加密與 Data Protection
使用 ASP.NET Core DataProtection 管理加密金鑰：
```csharp
// csharp
builder.Services.AddDataProtection()
    .PersistKeysToFileSystem(new DirectoryInfo(@"/keys"))
    .SetApplicationName("MyApp")
    .ProtectKeysWithDpapi(); // Windows DPAPI，跨平台可使用憑證
```
敏感資料加密：對敏感欄位如身分證號、信用卡使用應用層加密與欄位加密

### GDPR 與隱私實務
- 資料最小化（只收集必要資訊）
- 支援資料刪除／匿名化（right to erasure）
- 記錄同意與資料處理目的

### 常見安全風險與緩解
- SQL Injection：使用參數化查詢與 EF Core
- XSS：在輸出前做適當編碼與輸入驗證
- CSRF：使用 Anti-Forgery 機制

### 審計與日誌
- 使用 ABP Audit Logging 模組記錄操作事件
- 使用 Serilog/Seq 或 ELK 將日誌集中化

註冊 Serilog（範例）：
```csharp
// csharp
Log.Logger = new LoggerConfiguration()
    .Enrich.FromLogContext()
    .WriteTo.Console()
    .CreateLogger();

builder.Host.UseSerilog();
```

## 實務案例：從 N+1 問題到 Redis 快取
步驟：
1. 使用 EF Profiler 或慢查詢日誌找出 N+1 與重複查詢
2. 改用 Include / Select 投影，確認查詢次數與時間改善
3. 對熱點資料加入 Redis 快取並觀察 Cache hit/miss
4. 加入監控告警與回退策略（例如 Redis 當機時仍能使用 DB 直接讀取）

## 常見問題（FAQ）
Q：Redis 當機怎麼辦？  
A：實作快取回退（Cache-aside）與重試/斷路器（Polly），必要時降級到 DB 直接存取

Q：如何衡量快取效果？  
A：觀察 Cache hit rate、平均響應時間與後端 DB QPS

## 參考資源
- ABP 官方文件（Caching / Security / Data Protection）: https://docs.abp.io
- Microsoft Docs：Redis、Data Protection、Serilog

檔案：[`content/part08-ch18-19.md`](content/part08-ch18-19.md:1)