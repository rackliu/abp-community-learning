# 第五部：微服務與模組化（章 14–15）

本檔為教材第五部（章 14–15）教學草稿，包含微服務設計、YARP API Gateway 範例、Integration Service、模組化與 NuGet 發佈流程。

## 學習目標
- 設計微服務邊界與選用適切範本
- 建立 ABP 微服務解決方案並配置 API Gateway（YARP）
- 實作 Integration Service 與服務間通訊模式（事件/REST/gRPC）
- 封裝模組為 NuGet 並上傳發佈

## 先修需求
- 具備分層/模組化的 ABP 專案經驗
- 了解 REST、gRPC、訊息總線概念

## 14 微服務架構設計
### 何時採用微服務
- 團隊規模大、需要獨立部署或技術多樣性時考慮
- 若邊界不清楚，先採 Layered/Modular 再拆分

### 範本與建立
- 使用 ABP CLI 建立微服務範本：
```bash
# bash
abp new MyMicroservice -t microservice
```
- 建立單一服務（module）：
```bash
# bash
abp new MyModule -t module
```

### 服務邊界與資料擁有權
- 每個微服務擁有自己的資料存儲（避免直接存取他服務 DB）
- 透過事件或 API 提供資料同步或查詢 API

### 通訊模式比較
- REST：簡單、廣泛支援，適合同步查詢  
- gRPC：高效能、支援雙向串流，適合內部服務通訊  
- 訊息總線（RabbitMQ/Kafka）：非同步、適合跨服務事件傳播與最終一致性

## 15 模組化與 Integration Service
### 模組化設計（Application Module）
- 把通用功能封裝成模組（Domain + Application + Infrastructure），可在多個解決方案重複使用  
- 建立模組：[`abp new MyModule -t module`](content/part05-ch14-15.md:1)

### 封裝為 NuGet 套件
- 建議建立專門的模組專案並在 CI 中執行 pack：
```bash
# bash
dotnet pack -c Release
dotnet nuget push bin/Release/MyModule.*.nupkg --api-key <your-key> --source https://api.nuget.org/v3/index.json
```
- 在發佈前確認依賴最小化與語意版本（SemVer）

### Integration Service（服務整合）
- Integration Service 承擔外部系統或跨服務協調  
- 範式：事件驅動（推薦）或以 REST/gRPC 呼叫

#### 事件驅動設計範例
```csharp
// csharp
public class OrderCreatedIntegrationEventHandler : ILocalEventHandler<OrderCreatedEvent>
{
    public Task HandleEventAsync(OrderCreatedEvent eventData)
    {
        // 將事件發送到外部系統或其他服務
        return Task.CompletedTask;
    }
}
```

#### REST 呼叫注意事項
- 設定重試與斷路器（Polly）  
- 使用 HTTP Client Factory 並設定命名客戶端

### API Gateway（YARP）整合
#### 安裝 YARP 套件
```bash
# bash
dotnet add package Yarp.ReverseProxy
```
#### 簡易配置（`yarp.json`）
```json
{
  "Routes": [
    {
      "RouteId": "orders",
      "ClusterId": "ordersCluster",
      "Match": { "Path": "/orders/{**catch-all}" }
    }
  ],
  "Clusters": {
    "ordersCluster": {
      "Destinations": {
        "dest1": { "Address": "http://localhost:5001/" }
      }
    }
  }
}
```
- 將 `yarp.json` 加入 gateway 專案並在 `Program.cs` 中載入

```csharp
// csharp
builder.Services.AddReverseProxy().LoadFromConfig(builder.Configuration.GetSection("ReverseProxy"));
app.MapReverseProxy();
```

#### YARP 進階建議
- 使用健康檢查與權重路由配置  
- 在生產環境使用 TLS 與驗證（JWT/OAuth2）  
- 記錄請求以利追蹤（結合 Application Insights / Zipkin）

## 實務案例：建立微服務解決方案
1. 使用 CLI 建立微服務範本：[`abp new MyMicroservice -t microservice`](content/part05-ch14-15.md:1)  
2. 在每個 Service 中實作 Domain 與 Application 層  
3. 建立 Gateway 專案並加入 YARP 設定（`yarp.json`）  
4. 實作事件發佈：使用 RabbitMQ 或 Kafka 導入分散式事件總線  
5. 在 CI 建立 NuGet pack 與 Docker 映像並部署至 Kubernetes

## 最佳實務
- 從模組化開始，僅在必要時拆分微服務  
- 明確定義 API 合約與事件契約（契約版本管理）  
- 使用 CI/CD 自動化：建置、測試、pack、publish、deploy  
- 在服務間使用熔斷、重試、指數回退策略  
- 監控與可觀測性：分散式追蹤、指標（Prometheus）、日誌集中化（ELK/Seq/Datadog）

## 常見問題（FAQ）
Q：是否每個微服務都要有獨立 DB？  
A：推薦是，但可視情況使用共享讀庫或 CQRS 查詢服務，仍需注意一致性風險。

Q：如何測試微服務整合？  
A：使用合約測試（Pact）、整合測試容器（Testcontainers）與端對端測試環境。

## 參考資源
- ABP Microservice 文件：https://docs.abp.io/en/abp/latest/Microservice/Index  
- YARP 文件：https://microsoft.github.io/reverse-proxy/  
- Docker / Kubernetes 官方文件

---